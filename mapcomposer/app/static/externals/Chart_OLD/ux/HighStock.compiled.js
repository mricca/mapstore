/**
 * @author Joe Kuan
 * @email kuan.joe@gmail.com
 * @version 1.0
 * @date 8 May 2012
 *
 * You are not permitted to remove the author section from this file.
 */

if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a,c){var d=this.length,b=Number(c)||0,b=b<0?Math.ceil(b):Math.floor(b);for(b<0&&(b+=d);b<d;b++)if(b in this&&this[b]===a)return b;return-1};var logObj=function(a,c){var d="";if(c&&c.nameOnly)for(var b in a)d+=b+", ";else{for(b in a)d+=b+": "+a[b];Ext4.isObject(a[b])&&logObj(a[b])}};
Ext4.define("Chart.ux.HighStock",{extend:"Ext4.Component",alias:["widget.highstock"],stores:[],defaultSerieType:null,resizable:!0,updateDelay:0,loadMask:!1,config:{title:"",subTitle:""},initComponent:function(){if((!this.stores||!this.stores.length)&&this.store)this.stores=[this.store];if(this.stores.length)for(var a=0;a<this.stores.length;a++)this.stores[a]=Ext4.data.StoreManager.lookup(this.stores[a]);this.callParent(arguments)},addSeries:function(a,c){for(var c=c==null?!0:!1,d=[],b=[],e,f=0;f<a.length;f++)e=
Ext4.clone(a[f]),e=Ext4.create("Chart.ux.HighStockSerie",e),b.push(e.config),d.push(e);if(this.chart){c?(this.chartConfig.series=this.chartConfig.series?this.chartConfig.series.concat(b):b,this.series=this.series?this.series.concat(d):d):(this.removeAllSeries(),this.series=d,this.chartConfig.series=b);for(f=0;f<b.length;f++)this.chart.addSeries(b[f],!0);this.refresh()}else c?(this.chartConfig.series=this.chartConfig.series?this.chartConfig.series.concat(b):b,this.series=this.series?this.series.concat(d):
d):(this.chartConfig.series=b,this.series=d)},removeSerie:function(a,c){c=c||!0;this.chart&&(this.chart.series[a].remove(c),this.chartConfig.series.splice(a,1));this.series.splice(a,1)},removeAllSeries:function(){for(var a=this.series.length,c=0;c<a;c++)this.removeSerie(0)},setTitle:function(a){this.chartConfig.title?this.chartConfig.title.text=a:this.chartConfig.title={text:a};this.chart&&this.chart.container&&this.draw()},setSubTitle:function(a){this.chartConfig.subtitle?this.chartConfig.subtitle.text=
a:this.chartConfig.subtitle={text:a};this.chart&&this.chart.container&&this.draw()},initEvents:function(){if(this.loadMask)this.loadMask=new Ext4.LoadMask(this.el,Ext4.apply({stores:this.stores},this.loadMask))},afterRender:function(){this.stores&&Ext4.each(this.stores,function(a,c){this.bindSeriesStore(c,a,!0)},this);Chart.ux.HighStock.superclass.afterRender.call(this);this.bindComponent(!0);Ext4.apply(this.chartConfig.chart,{renderTo:this.el.dom});Ext4.applyIf(this.chartConfig,{xAxis:[{}]});this.xField&&
this.store&&this.updatexAxisData();this.series?this.addSeries(this.series,!1):this.series=[];this.initEvents()},onMove:function(){},draw:function(){if(this.stores){for(var a=0;a<this.stores.length;a++)if(this.stores[a].isLoading())return;for(var c=this.series.length,a=0;a<c;a++){if(this.series[a]&&this.series[a].plot!="flags")this.series[a].data=[];this.chartConfig.series[a]=this.series[a];this.chartConfig.series[a].type=this.chartConfig.series[a].plot?this.chartConfig.series[a].plot:"line"}if(this.stores.length==
this.series.length)for(a=0;a<this.stores.length;a++){if(this.chartConfig.series[a].type!="flags")for(var c=this.stores[a].data.items,d=0;d<c.length;d++){var b=c[d],e=this.series[a],b=e.getData(b);this.chartConfig.series[a].data.push(b)}}else{c=this.stores[0].data.items;for(d=0;d<c.length;d++)for(a=0;a<this.series.length;a++)this.chartConfig.series[a].type!="flags"&&(b=c[d],e=this.series[a],b=e.getData(b),this.chartConfig.series[a].data.push(b))}if(this.chart&&this.rendered){if(this.resizable){for(a=
0;a<this.series.length;a++)this.series[a].visible=this.chart.series[a].visible;this.chart.destroy();delete this.chart;a=this.chartConfig.series;this.chart=new Highcharts.StockChart(this.chartConfig);this.chartConfig.series=a}}else if(this.rendered)a=this.chartConfig.series,this.chart=new Highcharts.StockChart(this.chartConfig),this.chartConfig.series=a;for(a=0;a<this.series.length;a++)this.series[a].visible||this.chart.series[a].hide()}},onContainerResize:function(){this.draw()},updatexAxisData:function(){var a=
[],c=this.store.data.items;if(this.xField&&this.store){for(var d=0;d<c.length;d++)a.push(c[d].data[this.xField]);this.chart?this.chart.xAxis[0].setCategories(a,!0):this.chartConfig.xAxis[0].categories=a}},bindComponent:function(a){var c=function(a){return a.ownerCt?c(a.ownerCt):a},d=c(this);if(a){if(d.on("move",this.onMove,this),d.on("resize",this.onResize,this),this.ownerCt)this.ownerCt.on("render",this.update,this)}else this.ownerCt&&this.ownerCt.un("render",this.update,this),d.un("move",this.onMove,
this)},bindSeriesStore:function(a,c,d){var b=this.stores[a];!d&&b&&(c!==b&&b.autoDestroy?b.destroy():(b.un("datachanged",this.onDataChange,this),b.un("load",this.onLoad,this),b.un("add",this.onAdd,this),b.un("remove",this.onRemove,this),b.un("update",this.onUpdate,this),b.un("clear",this.onClear,this)));c&&(c=Ext4.StoreMgr.lookup(c),c.on({scope:this,load:this.onLoad,datachanged:this.onDataChange,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,clear:this.onClear}));(this.stores[a]=c)&&!d&&
c.load()},bindStore:function(a,c){!c&&this.store&&(a!==this.store&&this.store.autoDestroy?this.store.destroy():(this.store.un("datachanged",this.onDataChange,this),this.store.un("load",this.onLoad,this),this.store.un("add",this.onAdd,this),this.store.un("remove",this.onRemove,this),this.store.un("update",this.onUpdate,this),this.store.un("clear",this.onClear,this)));a&&(a=Ext4.StoreMgr.lookup(a),a.on({scope:this,load:this.onLoad,datachanged:this.onDataChange,add:this.onAdd,remove:this.onRemove,update:this.onUpdate,
clear:this.onClear}));(this.store=a)&&!c&&this.refresh()},refresh:function(){this.draw()},refreshRow:function(a){var c=this.store.indexOf(a);if(this.chart){for(var d=0;d<this.chart.series.length;d++){var b=this.chart.series[d],e=this.series[d].getData(a,c);this.series[d].type=="pie"&&this.series[d].useTotals?(this.series[d].update(a),this.chart.series[d].setData(this.series[d].getTotals())):b.data[c].update(e)}this.xField&&this.updatexAxisData()}},update:function(a){a=a||this.updateDelay;if(!this.updateTask)this.updateTask=
new Ext4.util.DelayedTask(this.draw,this);this.updateTask.delay(a)},onDataChange:function(){},onClear:function(){this.refresh()},onUpdate:function(a,c){this.refreshRow(c)},onAdd:function(a,c,d){for(var a=!1,b=[],e=0;e<c.length;e++){var f=c[e];e==c.length-1&&(a=!0);this.xField&&b.push(f.data[this.xField]);for(var h=0;h<this.chart.series.length;h++){var i=this.chart.series[h],g=this.series[h];if(g&&g.getData){var j=g.getData(f,d+e);g.type=="pie"&&g.useTotals||i.addPoint(j,a,!0)}}}this.xField&&this.chart.xAxis[0].setCategories(b,
!0)},onResize:function(){Chart.ux.HighStock.superclass.onResize.call(this);this.update()},onRemove:function(a,c,d){for(a=0;a<this.series.length;a++){var b=this.series[a];b.type=="pie"&&b.useTotals?(b.removeData(c,d),this.chart.series[a].setData(b.getTotals())):this.chart.series[a].data[d].remove(!0)}Ext4.each(this.chart.series,function(a){a.data[d].remove(!0)});this.xField&&this.updatexAxisData()},onLoad:function(){this.draw()},loadStores:function(){Ext4.each(this.stores,function(a){a.load()})},destroy:function(){delete this.series;
this.chart&&(this.chart.destroy(),delete this.chart);this.bindStore(null);this.bindComponent(null);Chart.ux.HighStock.superclass.destroy.call(this)}});Chart.ux.HighStock.Series=function(){var a=[],c=[];return{reg:function(d,b){a.push(b);c.push(d)},get:function(d){return a[c.indexOf(d)]}}}();
